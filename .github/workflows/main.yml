name: Animate Diff CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger
    inputs:
      prompt:
        description: 'Animation prompt'
        required: true
        default: 'A cat walking in the park'
      steps:
        description: 'Inference steps'
        required: false
        default: '25'

env:
  PYTHON_VERSION: '3.10'
  MODEL_CACHE: '~/.cache/huggingface/hub'

jobs:
  test-environment:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg libsm6 libxext6
        
    - name: Cache models
      uses: actions/cache@v3
      with:
        path: ${{ env.MODEL_CACHE }}
        key: ${{ runner.os }}-models-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-models-
          
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
        pip install -r requirements.txt
        pip install diffusers transformers accelerate opencv-python pillow imageio[ffmpeg]
        
    - name: Verify imports
      run: |
        python -c "
import torch
import diffusers
import transformers
print('All core dependencies installed successfully!')
print(f'PyTorch version: {torch.__version__}')
print(f'Diffusers version: {diffusers.__version__}')
        "
        
    - name: Run basic tests
      run: |
        python -m pytest tests/ -v --tb=short

  generate-animation:
    needs: test-environment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install animate-diffusion diffusers transformers
        
    - name: Create output directory
      run: mkdir -p outputs/animations
      
    - name: Generate animation
      run: |
        python scripts/generate_animation.py \
          --prompt "${{ github.event.inputs.prompt || 'A beautiful landscape animation' }}" \
          --steps ${{ github.event.inputs.steps || '25' }} \
          --output outputs/animations/animation_${{ github.sha }}.gif
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        
    - name: Upload animation artifact
      uses: actions/upload-artifact@v3
      with:
        name: generated-animations
        path: outputs/animations/
        retention-days: 7
        
    - name: Deploy to Hugging Face Spaces
      if: github.ref == 'refs/heads/main'
      run: |
        echo "Deploying to Hugging Face Spaces..."
        # Add your deployment script here
        python deploy_to_spaces.py

  model-training:
    needs: test-environment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python with GPU
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install CUDA dependencies
      run: |
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
        
    - name: Install training dependencies
      run: |
        pip install -r requirements-training.txt
        pip install accelerate deepspeed
        
    - name: Train Animate Diff model
      run: |
        python scripts/train_animate_diff.py \
          --dataset_path ./training_data \
          --output_dir ./trained_models \
          --batch_size 2 \
          --learning_rate 1e-5 \
          --max_steps 1000
          
    - name: Upload trained model
      uses: actions/upload-artifact@v3
      with:
        name: trained-model
        path: trained_models/
        retention-days: 30
