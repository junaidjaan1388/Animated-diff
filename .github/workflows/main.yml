name: Animate Diff CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Animation prompt'
        required: true
        default: 'A cat walking in the park'
      steps:
        description: 'Inference steps'
        required: false
        default: '25'

env:
  PYTHON_VERSION: '3.10'

jobs:
  setup-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4
      
    - uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        pip install --upgrade pip
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
        
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        else
          pip install diffusers transformers opencv-python pillow
        fi
        
    - name: Verify installation
      run: |
        python -c "
import torch, diffusers, transformers
print(f'PyTorch: {torch.__version__}')
print(f'Diffusers: {diffusers.__version__}')
print(f'Transformers: {transformers.__version__}')
print('All imports successful!')
        "

  generate-animation:
    needs: setup-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - uses: actions/checkout@v4
      
    - uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install deps
      run: |
        pip install torch torchvision torchaudio diffusers transformers
        
    - name: Generate animation
      run: |
        mkdir -p outputs
        echo "Animation Results" > outputs/animation.txt
        echo "Prompt: ${{ github.event.inputs.prompt }}" >> outputs/animation.txt
        echo "Steps: ${{ github.event.inputs.steps }}" >> outputs/animation.txt
        echo "SHA: ${{ github.sha }}" >> outputs/animation.txt
        cat outputs/animation.txt
        
    - uses: actions/upload-artifact@v4
      with:
        name: animation-result
        path: outputs/
        retention-days: 5
